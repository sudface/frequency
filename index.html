<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Sydney Bus Frequency Visualisation</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
        }

        #sidebar {
            width: 320px;
            border-right: 1px solid #ccc;
            padding: 12px;
            overflow-y: auto;
            display: none;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #controls {
            padding: 12px;
            background: #f5f5f5;
            border-bottom: 1px solid #ccc;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #map {
            flex: 1;
            min-height: 0;
        }

        #closeSidebar {
            float: right;
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
        }

        #helpBtn {
            right: 1em;
            border: 2px solid black;
            position: absolute;
            border-radius: 50%;
            width: 1.4em;
            text-align: center;
            line-height: 1.4em;
            font-weight: bold;
            cursor: pointer;
        }

        p.legal {
            font-size: 0.6rem;
            color: #666;
        }

        input.threshold {
            width: 6em
        }

        div.frequency-row {
            padding-top: 8px;
        }
    </style>
</head>

<body>
    <div id="sidebar"></div>

    <div id="main">
        <div id="controls">
            <label>Day:</label>
            <select id="dateSelect">
                <option value="20260115">Weekday</option>
                <option value="20260117">Saturday</option>
                <option value="20260118" selected>Sunday</option>
            </select>

            <label>From:</label>
            <input type="time" id="timeFrom" value="09:00" />

            <label>To:</label>
            <input type="time" id="timeTo" value="19:00" />

            <label>Min buses/hr:</label>
            <input type="number" class="threshold" id="minBph" value="0" min="0" step="1" />

            <button id="updateBtn">Update</button>

            <button id="changeColours">Change Colours</button>
            <span id="helpBtn">?</span>
        </div>

        <div id="map" width="500" height="300"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /*** pid-style css courtesy of Dr. ChatGPT :) ***/
        .pid {
            background: white;
            color: black;
            font-family: "Helvetica Neue", Arial, sans-serif;
            padding: 12px;
        }

        .pid-header {
            border-bottom: 2px solid #42a1da;
            margin-bottom: 8px;
            padding-bottom: 6px;
        }

        .pid-title {
            font-size: 11px;
            letter-spacing: 1px;
            color: #3192ce;
        }


        .pid-stop-name {
            font-size: 18px;
            font-weight: 700;
        }

        .pid-body {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .pid-row {
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            align-items: center;
            background: #efefef;
            padding: 6px 8px;
        }

        .pid-route {
            background: #42a1da;
            color: white;
            font-weight: 700;
            text-align: center;
            padding: 4px 0;
            border-radius: 3px;
            font-size: 14px;
        }

        .pid-destination {
            font-size: 14px;
            font-weight: 600;
            padding-left: 8px;
        }

        .pid-direction {
            font-size: 11px;
            font-weight: 400;
            color: gray;
        }

        .pid-time {
            text-align: right;
            font-size: 14px;
            font-family: "Courier New", monospace;
            color: blue;
        }

        .pid-empty {
            text-align: center;
            font-size: 14px;
            color: black;
            padding: 12px 0;
        }
    </style>

    <script>
        let map;
        let stopLayer = L.layerGroup();
        let dataset = null;

        function timeToMinutes(t) {
            const [h, m] = t.split(":").map(Number);
            return h * 60 + m;
        }

        function routeHasColour(route) {
            if (route.startsWith("B")) return "style='background-color: #f3ac00'";
            if (route.startsWith("N") || route.endsWith("N")) return "style='background-color: #0b2640'";
            if (route.startsWith("6") && route.endsWith("X")) return "style='background-color: #f3ac00'";
            if (route.startsWith("M")) return "style='background-color: #b91820'";
            if (route.startsWith("SW")) return "style='background-color: #e02091'";
            if (route == "T80") return "style='background-color: #264847'";
        }

        function showStopDetails(stopId, services, bph) {
            const sidebar = createSidebar();
            const [stopName] = dataset.stops[stopId];

            sidebar.innerHTML += `
                <div class="pid">
                    <div class="pid-header">
                        <div class="pid-title">${bph} buses per hour</div>
                        <div class="pid-stop-name">${stopName}</div>
                    </div>
                    <div class="pid-body"></div>
                </div>
            `;

            const body = sidebar.querySelector(".pid-body");

            if (services.length === 0) {
                body.innerHTML = `<div class="pid-row pid-empty">No services scheduled</div>`;
                return;
            }

            services.forEach(svc => {
                body.innerHTML += `
                    <div class="pid-row">
                        <div class="pid-route" ${routeHasColour(svc.routeNumber)}>${svc.routeNumber}</div>
                        <div class="pid-destination">
                            ${svc.routeName}
                            <div class="pid-direction">
                                ${svc.direction ? "Outbound" : "Inbound"}
                            </div>
                        </div>
                        <div class="pid-time">${svc.time}</div>
                    </div>
                `;
            });
        }

        function createSidebar() {
            const sidebar = document.getElementById("sidebar");
            sidebar.style.display = "block";
            sidebar.innerHTML = `<button id="closeSidebar" onclick='document.getElementById("sidebar").style.display = "none";'>×</button>`;
            return sidebar;
        }
    </script>
    
    <!-- Colours -->
    
    <script>
        /* ---------- Colours ---------- */

        const frequencyPresets = {
            threeClass: [ // color colour color coloUr 
                { min: 0, max: 1.5, color: "#ff0000" }, // red
                { min: 1.5, max: 3.5, color: "#ffa500" }, // orange
                { min: 3.5, max: Infinity, color: "#0000ff" } // blue
            ],

            fiveClass: [
                { min: 0, max: 1, color: "#f95858" }, // Red
                { min: 1.1, max: 3.9, color: "#ffa500" }, // Orange
                { min: 4, max: 5, color: "#53ca53" }, // Light Green
                { min: 5.1, max: 9.9, color: "#06402b" }, // Dark Green
                { min: 10, max: Infinity, color: "#010afe" } // Pink
            ]
        };

        // Clone because we allow user to mutate the data
        let frequencyClasses = structuredClone(frequencyPresets.threeClass);

        // Given a BPH, return the colour for that bus frequency
        function frequencyColor(bph) {
            for (const c of frequencyClasses) {
                if (bph >= c.min && bph <= c.max) {
                    return c.color;
                }
            }
            return "#000000"; // fallback
        }

        function showColourChanger() {
            const sidebar = createSidebar();
            sidebar.innerHTML += `
                <div id="frequency-controls">
                    <h3>Change Colours</h3>
            
                    <p>Change the rendering colours here. Select a range (inclusive) for each colour. The first matching range will be used.<br><br>Numbers are in <i>buses per hour</i>.</p>
                    <hr>
                    <label>
                        Number of colours:
                        <select id="frequency-preset">
                            <option value="threeClass">3 classes (default)</option>
                            <option value="fiveClass">5 classes</option>
                        </select>
                    </label>
            
                    <div id="frequency-editor"></div>
                </div>
            `;

            // If a colour or minmax changes, save.
            sidebar.addEventListener("change", e => {
                if (e.target.closest("#frequency-editor")) {
                    updateColours();
                }
            });

            // If the number of classes changes, reload the editor AND update vis.
            document.getElementById("frequency-preset").addEventListener("change", e => {
                const preset = frequencyPresets[e.target.value];
                frequencyClasses = structuredClone(preset);
                renderFrequencyEditor();
                updateVisualisation();
            });

            renderFrequencyEditor();
        }

        // For every class in frequencyClasses, show an input for min/max/colour
        function renderFrequencyEditor() {
            const editor = document.getElementById("frequency-editor");
            editor.innerHTML = "";

            frequencyClasses.forEach((c, i) => {
                editor.insertAdjacentHTML("beforeend", `
                    <div class="frequency-row">
                        <input type="number" class="threshold" step="0.1" value="${c.min}" data-i="${i}" data-which="min">
                        to
                        <input type="number" class="threshold" step="0.1" value="${c.max === Infinity ? "" : c.max}" placeholder="∞" data-i="${i}" data-which="max">
                        <input type="color" value="${c.color}" data-i="${i}" data-which="color">
                    </div>
                `);
            });
        }

        function updateColours() {
            const inputs = sidebar.querySelectorAll("#frequency-editor input");

            inputs.forEach(input => {
                const i = Number(input.dataset.i);
                const which = input.dataset.which; // min or max or colour

                if (which === "color") {
                    frequencyClasses[i].color = input.value;
                } else if (which === "max" && input.value === "") {
                    frequencyClasses[i][which] = Infinity;
                } else {
                    frequencyClasses[i][which] = parseFloat(input.value);
                }
            });

            updateVisualisation();
        }
    </script>

    <!-- Data -->

    <script>
        /* ---------- Data logic ---------- */
        function fetchData(date) {
            document.getElementById("updateBtn").innerText = "Loading...";
            document.getElementById("updateBtn").disabled = true;

            fetch(`./details_${date}.json`)
                .then(r => r.json())
                .then(json => {
                    dataset = json;
                    updateVisualisation();
                    document.getElementById("updateBtn").innerText = "Update";
                    document.getElementById("updateBtn").disabled = false;
                });
        }

        function updateVisualisation() {
            stopLayer.clearLayers();

            const fromMin = timeToMinutes(document.getElementById("timeFrom").value);
            const toMin = timeToMinutes(document.getElementById("timeTo").value);

            const stopdata = dataset.stops;
            const timedata = dataset.times;

            // First queue all stops to render. Then sort by frequency before rendering, so that higher frequency is "above" the lower fx.
            const stopsToRender = [];

            for (const stopId in timedata) {
                const [serviceTimes, tripIds] = timedata[stopId];

                let count = 0;
                for (const t of serviceTimes) {
                    if (t >= fromMin && t <= toMin) count++;
                }

                // Don't render if there are no services at all, or if fails the minBph
                if (count === 0) continue;

                const bph = count / ((toMin - fromMin) / 60);
                const minBph = Number(document.getElementById("minBph").value);
                if (bph < minBph) continue;

                // Add to render queue
                const [name, [lat, lon]] = stopdata[stopId];
                stopsToRender.push({ stopId, lat, lon, count, bph });
            }

            stopsToRender.sort((a, b) => a.bph - b.bph);

            stopsToRender.forEach(stop => addStop(stop));
        }

        function addStop(stop) {
            const fromMin = timeToMinutes(document.getElementById("timeFrom").value);
            const toMin = timeToMinutes(document.getElementById("timeTo").value);
            const timedata = dataset.times;

            const marker = L.circleMarker([stop.lat, stop.lon], {
                radius: 4,
                color: frequencyColor(stop.bph),
                fillOpacity: 0.8,
            });

            // Wow Javascript scoping. Redeclare stopId as a constant here otherwise bad things happen.
            const id = stop.stopId;

            // Generate the on-click sidebar.
            marker.on("click", () => {
                const services = [];

                // Get every service at that stopId in the allowed time range
                timedata[id][0].forEach((t, idx) => {
                    if (t < fromMin || t > toMin) return;

                    const tripId = timedata[id][1][idx];
                    const [routeId, direction] = dataset.trips[tripId];
                    const [routeNumber, routeName] = dataset.routes[routeId];

                    services.push({
                        routeNumber,
                        routeName,
                        direction,
                        time: `${Math.floor(t / 60).toString().padStart(2, "0")}:${(t % 60).toString().padStart(2, "0")}`
                    });
                });

                showStopDetails(id, services, stop.bph);
            });

            stopLayer.addLayer(marker);
        }
    </script>
    
    <!-- Load -->
    
    <script>
        // Register buttons and helptext, load data
        document.getElementById("dateSelect").addEventListener("change", (e) => { fetchData(e.target.value) });
        document.getElementById("updateBtn").addEventListener("click", updateVisualisation);
        document.getElementById("changeColours").addEventListener("click", showColourChanger);
        
        document.getElementById("helpBtn").addEventListener("click", () => {
            const sidebar = createSidebar();
            sidebar.innerHTML += `
                <h2>About</h2>
                This page shows the frequency at which bus service stops across the Sydney network. Stops along common corridors or interchanges will naturally have a much higher frequency than those around them.<br><br>
                Frequency is calculated in "Buses per hour", given by the average number of buses that stop over a given period. <br><br>
                You can click on a stop to view more details about the services in that timeframe. <br><br>
                This period and day of week can be customised using the inputs at the top. Day of week is given by 3 indicative days in January 2026 (15, 17, 18 Jan).<br><br>
                By default, Red shows stops with lower frequency, and Blue for higher frequency. The colour groupings can be customised using the "Change Colours" button. The map can also be filtered for stops above a certain frequency.<br><br>
                <hr><br>
                The information on this page is derived from data kindly <a href="https://opendata.transport.nsw.gov.au/data/dataset/public-transport-timetables-realtime/resource/9b3bfa13-0053-4008-8575-e30151f05d54">provided by Transport NSW</a>.<br><br>
                If you find any issues, would like to see the code, or can help make the website better, contribute <a href="https://github.com/sudface/frequency">here on github</a>.<br><br>
                <p class="legal">
                    Please be aware that the data presented on this website is subject to potential inaccuracies. 
                    While efforts have been made to ensure accuracy, we cannot guarantee the precision of the information.
                    You are advised to exercise discretion and independently verify the data before making any decisions based on it. 
                    The website owner and contributors are not liable for any consequences arising from the use of potentially inaccurate data.
                    <br><br>
                    This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
                    You are free to:<br>
                    - Share: Copy and redistribute the material in any medium or format.<br>
                    - Adapt: Remix, transform, and build upon the material for any purpose.<br>
                </p>
            `;

        });
        
        function initMap() {
            map = L.map("map").setView([-33.8148, 151], 12); // Parra

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "© OpenStreetMap contributors"
            }).addTo(map);

            stopLayer.addTo(map);
        }

        window.addEventListener("load", () => {
            const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|Mobile/i.test(navigator.userAgent);

            if (isMobile) {
                alert("This website is very performance intensive and is designed for Desktop Browsers. You might be using a Mobile Device. Please use a desktop browser for the best experience. Still proceed?");
            }

            fetchData("20260118");
            initMap();
        })
    </script>

</body>

</html>